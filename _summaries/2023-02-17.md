## 분산락(Distributed Lock)

### 락(Lock) 을 거는 이유? 동기화(synchronization)

동기화(synchronization) 는 여러 프로세스와 쓰레드가 올바르게 동작하도록 조정하는 행위를 말한다. 멀티 쓰레드 프로그래밍의 경우, 여러 쓰레드가 서로의 작업을
방해하거나 충돌을 일으키지 않도록 동기화가 필요하다. 뿐만 아니라 동기화는 분산 환경에서도 중요하다. 분산 환경은 여러 서버를 운용하는 환경 뿐만 아니라 멀티 프로세스
환경을 포함한다. 서로 다른 시스템이 효과적으로 동작하기 위해서는 각 노드 간에 올바르게 데이터를 공유하는 것은 중요하다.
잘못된 공유 자원 접근으로 인해 데이터 정합성이 깨져 프로세스 또는 쓰레드가 비정상 동작을 일으킨다. 이를 방지하기 위한 방법 중 하나가 락(Lock) 이다.

<br>

### 그렇다면 락(Lock) 은 무엇인가 ??

`락(Lock)` 은 일반적으로 동시에 공유자원의 접근을 하지 못하도록 잠금을 설정하는 동기화 방법 중 하나이다. 
프로세스가 정상적으로 동작하기 위해 중요한 요소 중 하나는 데이터 정합성이다. 데이터 정합성은 데이터들 간에 모순없이 값이 일치해야 하는 것을 말한다. 
일반적으로 어플리케이션은 분산 환경, 멀티쓰레드 또는 멀티 프로세스(e.g. 인스턴스 여러개) 를 통해 동작한다.
사용자에게는 동일한 결과 제공해야 하고, 개발자는 이를 위해 동기화에 신경써야 한다. 동기화를 위해 고려해야 하는 대표적인 예시가 공유자원에 대한 접근이다.
여러 쓰레드 혹은 여러 프로세스가 공유 자원에 동시에 접근할 경우, 데이터 정합성이 깨지는 경우가 발생할 수 있다. 이와 같은 경우를 동시성 이슈라 지칭하며 
락을 활용하여 동시에 공유자원을 접근을 막아 올바르게 데이터를 공유할 수 있게 도와주는 방법이다.

<br>

### 분산 락(Distributed Lock) : 분산 환경에서 동기화를 지원하기 위한 방법

 동기화를 지원하는 방법에는 다양하다. 자바에서는 `synchronized` 키워드로 모니터 기반 상호배제(mutual exclusion) 기능을 제공한다.
 하지만 `synchronized` 는 같은 프로세스일 경우에만 지원하므로 멀티 프로세스(e.g. 한 서버 내에 여러 인스턴스) 와 같은 분산 환경에서는 지원하지 않는다.
이와 같이 분산 환경에서 상호 배제를 지원하는 락을 분산 락(Distributed Lock) 이다. 분산 락은 락에 관한 정보를 공통적으로 보관하는 구역을 별도로 할당해
임계 영역(critical section) 에 대한 접근 여부를 확인할 수 있고 이를 통해 원자성(atomic) 을 보장할 수 있다. 분산 락을 지원하는 예시는 MySQL 의 네임드락,
Redis, Redission(Java Redis Client) 등이 있다.

<br>

### Redis 을 통해 분산락을 구현하는 방법 : SETNX, MessageBroker 

Redis 를 통해 분산락을 간단하게 구현할 수 있는 방법은 `SETNX(Set if Not eXists)` 명령어를 활용하는 방법이다. 즉, 키 값이 존재하지 않은 경우에만 값을
설정할 수 있는 명령어이다. 이 방식을 이용해 스핀락(spin lock) 을 구현할 수 있다. 스핀락은 지속적으로 락의 사용 여부를 확인하며 기다리는 방식을 말한다. 즉, 
`SETNX` 명령어를 통해 임계영역의 접근여부를 확인하는 매커니즘이다. 

또 다른 방법은 message broker 를 사용하는 방법이다. 락을 대기하는 프로세스에게 ‘락 획득 시도를 해도된다’ 라는 메시지를 발행하는 방식으로 동작한다.
자바 레디스 클라이언트인 `Redission` 라이브러리는 레디스 메세지 브로커 를 통해 분산락을 메커니즘을 구현하였다. 추가적으로 timeout 옵션을 지원해 일정 시간동안 
락을 획득하지 못한다면 예외를 발생시킬 수 있다.
```groovy
implementation 'org.redisson:redisson-spring-boot-starter:3.19.3'
```


### References

- [[Hudi blog] Redis로 분산 락을 구현해 동시성 이슈를 해결해보자!
  ](https://hudi.blog/distributed-lock-with-redis/)
- [[HiperConnect]레디스와 분산 락(1/2) - 레디스를 활용한 분산 락과 안전하고 빠른 락의 구현](https://hyperconnect.github.io/2019/11/15/redis-distributed-lock-1.html)

### To-Do-List

- [ ] Redission 학습해보기
- [ ] 동기화, 락에 관해 OS 공부해보기
